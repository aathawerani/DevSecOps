pipeline {
    agent any

    environment {
        AZURE_CREDENTIALS_ID = 'azure-prod-sp'
        AZURE_SUBSCRIPTION = 'f12a172b-b284-45ca-8c4b-3833481d3088'
        TF_STATE_RESOURCE_GROUP = 'terraform-state-rg' // RG containing Terraform state storage
        TF_STATE_STORAGE_ACCOUNT = 'tfstatesa'        // Storage account for Terraform state
        TF_STATE_CONTAINER = 'tfstate'                // Container for Terraform state
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM', 
                         branches: [[name: 'main']],
                         userRemoteConfigs: [[
                             credentialsId: '3ddb38d7-5108-4fae-865b-0120e45b2a0f',
                             url: 'https://github.com/aathawerani/DevSecOps.git'
                         ]]
                ])
            }
        }

        stage('Azure Login') {
            steps {
                withCredentials([azureServicePrincipal(AZURE_CREDENTIALS_ID)]) {
                    bat '''
                        az login --service-principal -u %AZURE_CLIENT_ID% -p %AZURE_CLIENT_SECRET% --tenant %AZURE_TENANT_ID%
                        az account set --subscription %AZURE_SUBSCRIPTION%
                    '''
                }
            }
        }

        stage('Identify Terraform-Managed Resources') {
            steps {
                script {
                    // Correct syntax for Azure CLI query in Jenkins pipeline
                    def tfResourceGroups = bat(
                        script: 'az group list --query "[?tags.\\`created-by\\`==\\`terraform\\`].name" -o tsv',
                        returnStdout: true
                    ).trim()

                    // Split into array and filter out empty lines
                    tfResourceGroups = tfResourceGroups.split('\n').findAll { it.trim() }

                    if (tfResourceGroups) {
                        echo "Found Terraform-managed resource groups: ${tfResourceGroups.join(', ')}"
                        env.TF_RESOURCE_GROUPS = tfResourceGroups.join(',')
                    } else {
                        echo "No Terraform-managed resource groups found"
                        env.TF_RESOURCE_GROUPS = ''
                    }
                }
            }
        }
                
        stage('Terraform Destroy') {
            when {
                expression { env.TF_RESOURCE_GROUPS?.trim() }
            }
            steps {
                script {
                    dir('ReactNode/terraform') {
                        withCredentials([azureServicePrincipal(AZURE_CREDENTIALS_ID)]) {
                            // Initialize Terraform with remote state
                            bat """
                                D:\\DevOps\\terraform\\terraform init ^
                                    -backend-config="resource_group_name=${TF_STATE_RESOURCE_GROUP}" ^
                                    -backend-config="storage_account_name=${TF_STATE_STORAGE_ACCOUNT}" ^
                                    -backend-config="container_name=${TF_STATE_CONTAINER}" ^
                                    -backend-config="key=terraform.tfstate"
                                
                                D:\\DevOps\\terraform\\terraform destroy -auto-approve
                            """
                        }
                    }
                }
            }
        }

        stage('Delete All Resource Groups') {
            steps {
                script {
                    // Get all resource groups (including non-Terraform ones)
                    def allResourceGroups = bat(
                        script: 'az group list --query "[].name" -o tsv',
                        returnStdout: true
                    ).trim().split('\n')

                    // Delete each resource group
                    allResourceGroups.each { rg ->
                        if (rg && !rg.startsWith('NetworkWatcherRG')) { // Skip Azure default RGs
                            bat """
                                echo "Deleting resource group: ${rg}"
                                az group delete --name "${rg}" --yes --no-wait
                            """
                        }
                    }
                }
            }
        }

        stage('Cleanup Orphaned Resources') {
            steps {
                script {
                    // Delete ungrouped resources
                    bat '''
                        echo "Cleaning up orphaned resources..."
                        az resource list --query "[?resourceGroup==null].id" -o tsv | % {
                            if ($_) { az resource delete --ids $_ --verbose }
                        }
                    '''

                    // Clean up Terraform state storage if empty
                    bat """
                        az storage container delete --name ${TF_STATE_CONTAINER} ^
                            --account-name ${TF_STATE_STORAGE_ACCOUNT} ^
                            --yes || echo "Container already deleted or doesn't exist"
                    """
                }
            }
        }

        stage('Verify Cleanup') {
            steps {
                script {
                    def remainingRGs = bat(
                        script: 'az group list --query "[].name" -o tsv',
                        returnStdout: true
                    ).trim().split('\n')

                    remainingRGs = remainingRGs.findAll { it && !it.startsWith('NetworkWatcherRG') }

                    if (remainingRGs) {
                        error("Cleanup incomplete! Remaining RGs: ${remainingRGs.join(', ')}")
                    } else {
                        echo "All resources successfully deleted"
                    }
                }
            }
        }
    }

    post {
        always {
            emailext body: """
                Azure Resource Cleanup ${currentBuild.currentResult}
                
                Terraform Resource Groups: ${env.TF_RESOURCE_GROUPS ?: 'NONE'}
                
                Build URL: ${BUILD_URL}
                Console Output: ${BUILD_URL}console
            """,
            subject: "Azure Cleanup ${currentBuild.currentResult}",
            to: "athawerani@gmail.com",
            attachLog: true
        }
        
        cleanup {
            bat 'az logout'
        }
    }
}