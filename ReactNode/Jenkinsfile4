pipeline {
    agent any
    parameters {
        string(name: 'RESOURCE_GROUP', defaultValue: 'pg-demo', description: 'Resource group to destroy')
        string(name: 'BUILD_NUMBER', defaultValue: '', description: 'Original build number')
    }
    
    environment {
        RESOURCE_GROUP = "pg-demo"
        STORAGE_ACCOUNT = "pgdemostorage"
        AZURE_CREDENTIALS_ID = 'azure-prod-sp'
    }
    
    stages {

        stage('Checkout') {
            steps {
                script {
                    failedStage = "Checkout"
                }
                git branch: 'main', credentialsId: '3ddb38d7-5108-4fae-865b-0120e45b2a0f', url: 'https://github.com/aathawerani/DevSecOps.git'
            }
        }

        
        stage('Azure Login') {
            steps {
                withCredentials([azureServicePrincipal(AZURE_CREDENTIALS_ID)]) {
                    bat """
                        az login --service-principal \
                            -u ${AZURE_CLIENT_ID} \
                            -p ${AZURE_CLIENT_SECRET} \
                            --tenant ${AZURE_TENANT_ID}
                    """
                }
            }
        }
        
        stage('Terraform Destroy') {
            steps {
                dir('terraform') {
                    bat """
                        D:\\DevOps\\terraform\\terraform init
                        D:\\DevOps\\terraform\\terraform destroy -auto-approve \
                            -var="resource_group_name=${RESOURCE_GROUP}"
                    """
                }
            }
        }

        stage('Delete Terraform Backend') {
            steps {
                withCredentials([azureServicePrincipal(AZURE_CREDENTIALS_ID)]) {
                    bat """
                        az login --service-principal ^
                            -u ${AZURE_CLIENT_ID} ^
                            -p ${AZURE_CLIENT_SECRET} ^
                            --tenant ${AZURE_TENANT_ID}
                        az account set --subscription ${AZURE_SUBSCRIPTION}

                        echo "Deleting backend container and storage account..."
                        az storage container delete ^
                            --name tfstate ^
                            --account-name ${STORAGE_ACCOUNT} ^
                            --yes

                        az storage account delete ^
                            --name ${STORAGE_ACCOUNT} ^
                            --resource-group ${RESOURCE_GROUP} ^
                            --yes
                    """
                }
            }
        }

        stage('Delete ACR Registry') {
            steps {
                withCredentials([azureServicePrincipal(AZURE_CREDENTIALS_ID)]) {
                    bat """
                        az login --service-principal ^
                            -u ${AZURE_CLIENT_ID} ^
                            -p ${AZURE_CLIENT_SECRET} ^
                            --tenant ${AZURE_TENANT_ID}
                        az account set --subscription f12a172b-b284-45ca-8c4b-3833481d3088
                        
                        echo "Deleting ACR: ${AZURE_REGISTRY}"
                        az acr delete --name ${AZURE_REGISTRY} --resource-group ${RESOURCE_GROUP} --yes
                    """
                }
            }
        }

        
        stage('Verify Destruction') {
            steps {
                script {
                    def rgExists = bat(
                        script: "az group exists --name ${RESOURCE_GROUP}",
                        returnStdout: true
                    ).trim()
                    
                    if (rgExists == "true") {
                        error("Resource group still exists after destruction!")
                    } else {
                        echo "Resource group ${RESOURCE_GROUP} successfully deleted"
                    }
                }
            }
        }
    }
    
    post {
        always {
            emailext body: """
                Resource destruction ${currentBuild.currentResult} 
                
                Resource Group: ${RESOURCE_GROUP}
                
                Jenkins build: ${BUILD_URL}
            """,
            subject: "Destruction ${currentBuild.currentResult}: PaymentGateway ",
            to: "athawerani@gmail.com"
        }
    }
}